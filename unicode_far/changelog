svs 28.12.2007 13:39:19 +0300 - build 397

1. Mantis#0000452: Bug, doubling code and improvements in hotplug.cpp 

svs 23.12.2007 16:14:14 +0300 - build 396

from Alexey Samlyukov:

1. memcpy()/wmemcpy() + прочая уникодная мелочь + убраны анахронизмы (#if defined(FAR_ANSI)), может и зря..

svs 23.12.2007 15:54:37 +0300 - build 395

1. Mantis#0000447: Buffer overrun in Edit:ProcessKey() 

2. Mantis#0000446: Wrong function to free memory in TreeList::SaveState()

3. Mantis#0000449: Handle leak in History::ReadHistory()

4. Mantis#0000444: Bugs and memory leaks in class History

5. Mantis#0000441: Cannot delete file "Descript.ion" 
   Здесь в panel.hpp было неправильное определение виртуальной функции GetDizName(). 
   Поэтому в ShellDelete() конструкция SrcPanel->GetDizName(strDizName); возвращала... 
   да ничего она не возвращала!

yjh 15.12.2007 00:54:56 +0300 - build 394

1. Доделка фильтров "исключения" при поиске (Alt-F7) в отношении каталогов.
   Теперь поведение фильтров такое же как в копировании, т.е. если включена
   фильтрации и в списке есть "запрещающий" (-) фильтр, то когда под его
   действие попадает каталог пропускается не только сам каталог, но и всё
   что находится в нём (и его подкаталогах). Разумеется, это верно только при 
   выключенном D+ :)


svs 15.12.2007 00:35:38 +0300 - build 393

1. Неправильно сохранялись макросы, содержащие буквы, оличные от латиницы.
   По этому поводу:
   а) уточнение в KeyNameToKey и KeyToText;
   б) в KeyMacro::ReadMacros юзалась не та функция GetRegKey().

drkns 14.12.2007 21:59:01 +0200 - build 392

1. Меню плагинов можно вызывать по F11 из диалогов.
   Чтобы попасть в это меню, плагин должен установить флаг PF_DIALOG в PluginInfo.Flags.
   Вызванный плагин получает следующие параметры в OpenPlugin():
   - OpenFrom: OPEN_DIALOG
   - Item: указатель на структуру OpenDlgPluginData:
     struct OpenDlgPluginData
     {
      int ItemNumber; //номер выбранного пункта в меню из зарегистрированных плагином пунктов
      HANDLE hDlg;    //хэндл диалога, из которого вызван плагин
     };

2. Плагин может экспортировать ProcessDialogEvent для обработки поступающих в диалог событий:
   int ProcessDialogEvent(int Event, void* Param)
   Event:
    DE_DLGPROCINIT - событие поступает в обработчик
    DE_DEFDLGPROCINIT - событие поступает в стандартный обработчик
    DE_DLGPROCEND - событие уже обработано

   Param - указатель на структуру FarDialogEvent:
   struct FarDialogEvent
   {
    HANDLE hDlg;
    int Msg;
    int Param1;
    LONG_PTR Param2;
    LONG_PTR Result;
   };

   return:
   - TRUE - событие обработали сами, не продолжать обработку.
     FarDialogEvent.Result - указатель на переменную, используемую обработчиком
     в качестве возвращаемого значения.
   - FALSE - продолжить обработку события.

svs 14.12.2007 13:45:16 +0300 - build 391

from Alexander Mitin

1. Mantis#0000432: Assertion while creating a submenu in User Menu 

2. Mantis#0000431: Crash when deleting the File Highlighting entry 

3. Mantis#0000430: Crash in "Системные параметры"


svs 13.12.2007 20:31:34 +0300 - build 390

1. Mantis#0000433: Updated operator new in new.cpp 

2. Mantis#408: Memory leak in struct MacroState.
    тыкс... перебор вышел с Work.locVarTable :-(
    Сам "Work.locVarTable" нужно удалять только в деструкторе. 
    В остальных случаях - только содержимое таблицы. 

3. API: Команда MCMD_GETSTATE для ACTL_KEYMACRO, 
    возвращает одно из значений (перечисление FARMACROSTATE):
      enum FARMACROSTATE {
        MACROSTATE_NOMACRO          =0,  // не в режиме макро
        MACROSTATE_EXECUTING        =1,  // исполнение: без передачи плагину пимп
        MACROSTATE_EXECUTING_COMMON =2,  // исполнение: с передачей плагину пимп
        MACROSTATE_RECORDING        =3,  // запись: без передачи плагину пимп
        MACROSTATE_RECORDING_COMMON =4,  // запись: с передачей плагину пимп
      };

4. Попытка исправить 
   Mantis#0000432: Assertion while creating a submenu in User Menu 
   Mantis#0000430: Crash in "Системные параметры"

svs 10.12.2007 21:22:18 +0300 - build 389

1. Mantis#0000428: Вновь DI_COMBOBOX 
   Отсутствовала проверка на тип элемента.

2. Mantis#0000429: Не очищается и не сохраняется кеш директорий

3. Macro: BOF, EOF, EMPTY и SELECTED не обрабатывались в ком.строке

4. Mantis#0000415: произошли какие-то непонятные изменения в DI_COMBOBOX
   (сломалось в 306)

5. API: пусть OPEN_FILEPANEL будет официальным, а не спрятанным.

t-rex 08.12.2007 23:40:46 +0200 - build 388

От Stanislav Vinokurov:

1. Mantis#411: Batch files are executed in the external window.

t-rex 08.12.2007 17:55:02 +0200 - build 387

1. Mantis#416: Crash while deleting folders
   Это в общем более глубокая проблема была, глюк был в UnicodeString,
   размер буффера рос при операциях для которых его рост был не нужен и при многих
   операциях над одной и той же строкой буффер вырастал до нереальных значений.

2. Mantis#408: Memory leak in struct MacroState.

3. Коррупция хипа при удаление несуществующих макросов.

4. Некорректное сохранение REG_MULTI_SZ макросов.

5. From Hannes Eder: StrLength in clipboard.cpp.

6. Потенциальные коррупции хипа и за неправильного не/использование sizeof(wchar_t) в паре мест.

7. От Alexey Samlyukov: wmem* вместо mem* в strmix.cpp.

t-rex 07.12.2007 16:36:54 +0200 - build 386

1. Mantis#421: Memory leak caused by using memset() to initialize values of structures.

svs 06.12.2007 18:45:06 +0300 - build 385

1. 2 новых эвента для панельного плагина: FE_GOTFOCUS и FE_KILLFOCUS
   Параметр Param для ProcessEvent равен NULL.
   В соответствии с этим переделан механизм (очередность) посыла событий - сначала Gotfocus, а потом остальное.
   Для этого в SetPluginMode() добавлен параметр SendOnFocus

2. В диалогах, сразу после DN_INITDIALOG приходит DN_GOTFOCUS для того элемента, который Focus=1

3. 2 новых эвента для редакторного плагина: EE_GOTFOCUS и EE_KILLFOCUS
   Параметр Param для ProcessEditorEvent равен EditorID.
   Для этого в класс FileEditor добавлена virtual функция OnChangeFocus.


svs 06.12.2007 13:31:33 +0300 - build 384

1. Mantis#0000417: Memory leak in Viewer::ProcessKey() 

2. Mantis#0000418: Wrong memory copy function used in TArray<Object>::Pack()

3. Mantis#0000419: Wrong memory copy function used in ScreenBuf::Scroll(int Num)

4. Mantis#0000420: INVALID_HANDLE_VALUE used in FindClose() in ScanTree::GetNextName() 


svs 05.12.2007 17:29:24 +0300 - build 383

1. Mantis#0000414: Handle leak in FileEditor::LoadFile()

2. Mantis#0000412: Wrong delete type in Language::Init()

3. Mantis#0000413: Wrong delete type in FileEditor::SaveFile()


t-rex 04.12.2007 23:41:54 +0200 - build 382

1. Различные глюки - по большому кривое использование sizeof в связи с wchar_t.

drkns 04.12.2007 19:55:33 +0200 - build 381

1. Мелкий глюк в 379.

svs 04.12.2007 20:25:07 +0300 - build 380

1. Mantis#0000410: Memory leak in class History

drkns 04.12.2007 18:51:36 +0200 - build 379

1. Mantis#0000409: User Menu (F2) doesn't handle process INS key when Opt.UseNumPad == 1
   Также поправлено в истории строк ввода, ссылках на папки, фильтрах и ассоциациях.

svs 04.12.2007 09:26:51 +0300 - build 378

1. Mantis#0000354: Goto dialog in editor
   Здесь сделано не так, как хотелка звучит.
   Добавлен флаг DIF_NOAUTOCOMPLETE, но т.к. код в dialog.cpp закомменчен, то
   просто обозначено место в коде...

2. Mantis#0000331: ... 
   про комбобокс; уточнение:
   - корректировка Top`а
   - динамическое изменение открытого выпадающего списка (Hide+Show)


t-rex 04.12.2007 08:18:31 +0200 - build 377

1. Mantis#406: Memory corruption and crash in Editor::AddUndoData().

2. Mantis#407: Memory leak in CommandLine class.

t-rex 03.12.2007 23:19:20 +0200 - build 376

1. Mantis#367: Не загружаются плагины, когда FAR запущен из папки которая сама или одина из её папок более высокого уровня являются связью.

2. Mantis#401: Handle leak in ProcessGlobalFileTypes().

3. Mantis#402: Handle leak in History::SaveHistory().

4. Mantis#403: Not initialized variable used in MessageRemoveConnection().

5. Mantis#404: Handle leak in CopyKeyTree().

6. Mantis#400: Function xf_wcsdup() should replace wcsdup().

drkns 03.12.2007 20:20:28 +0200 - build 375

1. Mantis#0000364: Maximize button doesn't work as expected
   Попробуем с другой стороны :-)
   Теперь работает "as expected" (кнопка, даблклик по заголовку, Maximize/Restore в системном меню и т. п.)
   Также учитывается состояние окна консоли при старте (start /max, настройка в lnk и т. п.)

drkns 03.12.2007 07:54:40 +0200 - build 374

1. Mantis#0000399: Memory leak in add_sid_cache()

2. Не работал DM_SETDLGITEM

t-rex 03.12.2007 00:01:04 +0200 - build 373

1. По наводке от Sten, Mantis#398: Patches to fix crashes after adding file to archive by pressing Shift+F1/Enter.

2. One of the memory leaks fixed in 372 was not a memory leak at all :), it was a perfectly correct code.

t-rex 02.12.2007 23:06:15 +0200 - build 372

1. From Hannes Eder: removed unused variables and corrected a condition in macro processing.

2. Fixed two memory leaks found along the way.

t-rex 02.12.2007 20:05:17 +0200 - build 371

1. От Stanislav Vinokurov: Mantis#397: Неправильная обработка oldfar::DM_GETTEXTPTR в FarSendDlgMessageA()

2. Тоже самое для oldfar::DM_GETTEXT.

t-rex 02.12.2007 13:59:53 +0200 - build 370

1. Из Mantis#396, неверная проверка при реалоке в TreeList::ReadTreeFile.

t-rex 02.12.2007 00:15:59 +0200 - build 369

1. Mantis#394: В OpenFilePlugin() должен передаваться в Name полный путь, а не имя файла.

t-rex 01.12.2007 19:47:22 +0200 - build 368

1. Memory leak в DeletePluginItemList.

2. Mantis#314: поле Description в PluginPanelItem находится мусор при вызове GetFilesW.
   И дупликат, Mantis#393.

3. Mantis#380: Memory leak in ConvertWildcards().

t-rex 01.12.2007 15:54:34 +0200 - build 367

от Stanislav Vinokurov (Sten):

1. Mantis#391: Wrapper: Реализация FarRecursiveSearchA.

2. Mantis#392: Wrapper: Некорректная обработка DI_EDIT и DI_FIXEDIT в AnsiDialogItemToUnicode().

t-rex 30.11.2007 16:28:14 +0200 - build 366

от Alexey Samlyukov:

1. Mantis#388: фиксы инициализации диалогов File/Folder descriptions.

t-rex 30.11.2007 16:12:41 +0200 - build 365

от Alexandr Zamaraev:

1. Mantis#387: copy.cpp, цикл подсчёта количества вместо вызова функции.

t-rex 30.11.2007 16:02:33 +0200 - build 364

от Alexey Samlyukov:

1. Mantis#389: удалим ConvertOldSettings().

t-rex 30.11.2007 15:30:14 +0200 - build 363

1. UnicodeString: Удалил RShift, глюкодром полный и оно не нужно.

2. UnicodeString: Исправил LShift, не выставлялась длина строки после изменения.

3. По наводке от Sten, неправильно работал цикл в PluginManager::OpenFilePlugin.

drkns 27.11.2007 21:20:14 +0200 - build 362

1. Обновление DialogAPI: FarListItem.Text теперь const wchar_t*.
   Плагины c DI_LISTBOX/DI_COMBOBOX надо править.

2. Криво работал DM_LISTGETITEM.

svs 27.11.2007 09:46:25 +0300 - build 361

1. TechInfo#48 по умолчанию делаем 1, а для Numpad5 TechInfo#48 игнорируем.

2. Mantis#0000360: Неверное отображение назначаемой клавиши
   Здесь есть вопросы...
   а) Не отработан код (в InitKeysArray), когда TechInfo#21 == 0
   б) проверял под двумя локалями - 409 и 419: проверить бы на остальных.
   с) замечено (кстати, в 1.7x тоже самое) в русской раскладке 2 правых 
      нижних клавиши '.' и '/' выдают один и тот же код ==> '.', т.к.
      нажали <.> ==> LocalKeyToKey(0x44E) ==> 0x2E
      нажали </> ==> LocalKeyToKey(0x02E) ==> 0x2E
      В принципе, на работоспособность это не влияет, но визуально...

3. Уточнения в SysLogDump()

svs 26.11.2007 12:49:47 +0300 - build 360

From Alexander Mitin (alexmitin):
1. Mantis#0000379: Memory corruption in QuickView::DisplayObject() 
   
В остальном - в keyboard.cpp local.cpp macro.cpp отмечены спорные моменты для Mantis#360

t-rex 25.11.2007 21:15:46 +0200

Без билда.

1. Не нужный "wchar_t *m_lpwszBuffer" в UnicodeString.hpp.

2. Обновления в HACKING-*.

t-rex 25.11.2007 20:39:14 +0200 - build 359

от Alexey Samlyukov:

1. Mantis#376: Фикс диалога Viewer settings.

drkns 24.11.2007 18:24:58 +0200 - build 358

1. Не обрабатывались макросы, содержащие макрокоманды $If, $Else и т. п.

2. Не работала макрофункция Date().


t-rex 24.11.2007 18:03:42 +0200 - build 357

1. Mantis#375: Не вызывался Network плагин при ChangeUp из сетевого ресурса. По наводке Redart.

t-rex 24.11.2007 17:30:03 +0200 - build 356

1. Вернул поиск в редакторе.

2. При поиске в редакторе мог пропадать курсор.

drkns 22.11.2007 19:33:01 +0200 - build 355

1. Mantis#0000365: Падение при вводе любого символа в поле "Опциональный символ пометки" в диалоге фильтра раскраски файлов

2. Mantis#0000366: В диалоге раскраски файлов и групп сортировки не всегда корректно показываются опциональные символы пометки


svs 19.11.2007 11:57:58 +0300 - build 354

1. Mantis#0000358: Для элемента "точки" PluginPanelItem.UserData всегда 0 

t-rex 18.11.2007 23:23:43 +0200 - build 353

1. Доделал DN_EDITCHANGE и DN_DRAWDLGITEM на предмет передачи FarDialogItem.

2. Юзаем правильные xf_(free|malloc|realloc) во всём коде.

drkns 18.11.2007 12:11:21 +0200 - build 352

1. для меню пользователя выставлялась макрообласть Menu, a не UserMenu.


t-rex 18.11.2007 02:19:42 +0200 - build 351

1. Mantis#357 По наводке от Oleg Bekhter: Удар по памяти при удаление блока в редакторе.

t-rex 18.11.2007 01:33:22 +0200 - build 350

1. Мешанина new и malloc при работе с Clipboard.
   Заодно убраны пару мем ликов и около того.

2. Юзаем правильные xf_(free|malloc|realloc) во врапере.

t-rex 16.11.2007 22:52:36 +0200 - build 349

1. Снова обновление DialogAPI, теперь вроде бы с ним удобно работать
   (нету больше аллокатора и выходных данных).
   Плагины которые используют DialogAPI надо переделывать!
-----------------------------------------
   Описание нового API:
   Теперь есть 3 функции: (Dialog и DialogEx больше нету)
   а. HANDLE DialogInit(те же параметры что и были у DialogEx), возвращает
      описатель диалога или INVALID_HANDLE_VALUE в случае ошибки.
   б. int DialogRun(HANDLE hDlg), запускает диалог, возвращает то что раньше
      возвращал DialogEx.
   с. void DialogFree(HANDLE hDlg), освобождает всю память связанную с диалогом.

   FarDialogItem уже не имеет DataIn и DataOut а только const wchar_t *PtrData.
   Этот PtrData является начальным текстом для элемента.

   Главное отличие от старого DialogAPI это то что массив структур FarDialogItem
   является только входным, в него не пишутся ни какие изменения при закрытии
   диалога.

   Система работы с новым API такова:
   DialogInit()
   DialogRun()
   *** различные вызовы SendDlgMessage()                ***
   *** для получения нужных выходных данных из диалога. ***
   DialogFree()

   Также появились дополнительные DM_* и изменён один старый:
   а. DM_GETDLGITEM - изменён, Param2 должен быть 0, а поинтер на нужный 
                      элемент возвращается самой функцией (NULL если ошибка).
                      Фар сам аллоцирует память под элемент, его нельзя
                      изменять и в конце использования его надо освободить с
                      помощью DM_FREEDLGITEM.
   б. DM_FREEDLGITEM - освобождает элемент полученый с помощью DM_GETDLGITEM.
                       Param1=0, Param2 = поинтер полученый от DM_GETDLGITEM.
   с. DM_GETCONSTTEXTPTR - возвращает (const wchar_t *) поинтер на внутренний
                           буффер фара связаный со строкой элемента. Не в коем
                           случае нельзя изменять, а также нельзя сохранять сам
                           поинтер так как он меняется при изменениях в строке
                           элемента. Добавлен для удобства работы после
                           закрытия диалога (DialogRun) и до DialogFree, но
                           можно конечно использовать и в обработчике, только
                           аккуратно :). Param1 = ID элемента, Param2 = 0.
-----------------------------------------

yjh 16.11.2007 07:20:48 +0300 - build 348

1. В операции Move при включенной фильтрации не удалялся полностью 
   скопированный каталог

2. В операции Move при включенной фильтрации пустые каталоги не копировались
   даже если они соотвествуют фильту


yjh 16.11.2007 00:17:38 +0300 - build 347

1. В правке фильтров исключений не учитывался запрет на фильтрацию каталогов



drkns 15.11.2007 20:04:49 +0200 - build 346

1. Ещё одна небольшая правка с овнерами.


yjh 15.11.2007 04:10:08 +0300 - build 345

1. Доделка фильтров "исключения" при копировании в отношении каталогов.
   Если при копировании включена фильтраци, то в отношении "разрещающих" 
   фильтров всё работает как раньше. В отношении же "запрещающих" (-) фильтров,
   если встречается каталог подпадающий под действие фильтра, то пропускается
   и он и всё его содержимое

2. Убрана пара BUGBUG в копировании при включенных фильтрах. Теперь работает :)


drkns 14.11.2007 22:22:05 +0200 - build 344

1. Мелкий глюк в 343.

drkns 14.11.2007 21:22:05 +0200 - build 343

1. Не обрабатывалась маска %pathext% в раскраске файлов.

2. В режиме отображения овнеров не работало кеширование и не освобождалась память.

3. К типу колонки "владелец файла" можно добавлять флаг 'L' - отображать домен.

4. Можно вводить юникодные символы по Alt-NumX :)


yjh 14.11.2007 22:04:42 +0300 - build 342

1. В FarMkTempEx игнорировлася параметр WithPath, что далеко не всегда допустимо

2. В FarMkTempEx убран потенциальный infinite loop. При ошибке возвращается
   "пустая" строка (при референсах по другому не получится)

3. В WipeDirectory переименование сделано именно переименованием (inplace) 
   вместо "перемещения". Это дешевле, исчезает ошибка "восстановления" (при
   невозможности удаления и ответе Skip оставались частично переименованные
   каталоги, да ещё и не всегда на своём месте :), меньше вероятность нарваться
   на "забитость" каталога (при генерации имени временного файла).
   Кроме того. в старой логие оно вооще не могло работать, когда  Opt.TempPath 
   на другом диске - MoveFile не позволяет перемещать каталоги между дисками



drkns 13.11.2007 22:45:17 +0200 - build 341

1. Падение в режиме панели "File owners".

2. В панелях не работал быстрый поиск по неанглийским символам.

3. Правки на предмет юникода в меню выбора принтера.


yjh 13.11.2007 09:44:34 +0300

1. Возможность компилировать хук vc7 (для извращенцев :). Очень рекомендую
   в этом случае омпилировать определив -DLINK_WITH_ULINK и компоновать
   ulink'ом. В противном случае, работать-то будет, но меньше степень
   защиты :). О чём будет сообщение при компиляции :)


yjh 13.11.2007 07:06:56 +0300 - build 340

1. FarNameToKey для плугинов


yjh 13.11.2007 03:04:15 +0300 - build 339

1. Hook позволяющий 32хбитовому Far'у корректно работать с FS в Win64 
   (отключение WOW64-fs redirection). По умолчанию оно отключено и
   включается только на моменты загрузки DLL/запуска задач (для "штатной"
   работы 32хбитовых процессов).
   При желании собрать Far без этого кода следует определить (для make)
   DISABLE_WOW64_HOOK.
   Корректно это будет компоноваться (и, как следствие, работать) либо
   ms-link не ниже чем от vc8, либо ulink версии >= 1.05 build 3.9 (лучше 
   использовать build >= 3.11 - иначе будет ненужное информационное сообщение).


t-rex 12.11.2007 22:58:42 +0200 - build 338

1. Пару глюков в открытие хэлпа в фаре и в АПЙ.

drkns 12.11.2007 21:59:08 +0200 - build 337

1. Мелкие правки во враппере

2. При записи макроса руками по Ctrl. запоминалась только последняя нажатая клавиша.

3. Цикличный перевод фокуса с первого элемента диалога на последний приводил к зависанию.

4. В меню дисков нельзя было одновременно включить показ метки и файловой системы.

svs 12.11.2007 19:09:32 +0300 - build 336

1. Mantis#0000352: Undo, вызываемое CTRL+Z не работает если открыть существующий файл на редактирование
   Продолжаем...
   ...слишком мало данных сохранялось :-(

svs 12.11.2007 14:51:46 +0300 - build 335

1. Падает FAR в следующих ситуациях:

   a) Запущен FAR без макросов в реестре
   b) Запущен FAR с макросами в реестре но запущен как Far.exe /m
   c) Запущен FAR с макросами но их удалили во время сеанса FAR и вызвали плагин UpdateMacros.dll

   когда падает:

   Ctrl. Ctrl. Любая_допустимая_клавиша Enter
   FAR упал

2. Пусть у нас есть 2 макроса:
   [HKEY_CURRENT_USER\Software\Far\KeyMacros\Shell\F10]
   "Sequence"="F5" 
   [HKEY_CURRENT_USER\Software\Far\KeyMacros\Common\F10]
   "Sequence"="F4"

   запускаем FAR
   находясь на панели жмем Ctrl. Ctrl. F10
   выбираем "ДА" 

   ещё раз делаем Ctrl. Ctrl. F10
   выбираем "ДА"
   
   жмем F10 и видим макрос не снялся если ещё раз сделать Ctrl. Ctrl. F10 
   нам опять предлагает удалить...

   те макрос (общий) в такой ситуации не снимается



yjh 11.11.2007 22:33:53 +0300 - build 334

1. plugin.hpp скорректирован для работы с .c (не .cpp) файлами


t-rex 10.11.2007 23:26:42 +0200 - build 333

1. Правки во врапере по теме нового DialogAPI и около.

2. ViewerInfoW -> ViewerInfo.

yjh 10.11.2007 20:39:24 +0300 - build 332

1. Убран memory leak в GETDLGITEM

2. Добавлен DM_GETREALLOC (для враппера и DialogManager)

3. ВНИМАНИЕ: при получении Item с динамическим буфером
             (IsEdit(Type) && MaxLen==0)
             выделенный буфер (DataOut) должен особождаться плагином


t-rex 10.11.2007 19:11:17 +0200 - build 331

1. Напутал с CutToSlash в 326.

yjh 10.11.2007 18:41:37 +0300 - build 330

1. Изменения в DialogAPI (для нормальной работы с памятью редактируемых
   строк). 
   !!!ВНИМАНИЕ!!! почти все (уже "готовые" плугины надо править)
***
   Краткое описание нового API:
    В FarDialogItem есть 3 поля 
      const wchar_t* DataIn;
      wchar_t* DataOut;
      size_t MaxLen;
    DataIn - задаёт все ВХОДНЫЕ строковые данные (было в DataPtr)
    DataOut - для полей с редактируемоей строкой (см. IsEdit() в pluging.hpp)
              здесь находится указатель на возвращаемые данные.
              для всех остальных типов полей всегда возвращается NULL (см. ниже)
    MaxLen имеет двойное назначение:
       if(MaxLen != 0), то это максимальный размер (включая закрывающий 0)
       ЗАРАНЕЕ выделенного (плугином) буфера указатель на который должен 
       передаваться через DataOut.
       Кроме того, это ограничитель размера для строки ввода (currently not implemented)

       Если же MaxLen==0, то подразумевается, что работа(редактирование) идёт
       со строками с НЕ лимитированным размером. В этом случае в DataOut 
       попадает указатель на динамически выделяемую память (см. ниже) которую
       плугин должен особождать сам.

    В ф-циях FSF.Dialog и FSF.DialogEx добавил ещё один параметр - указатель
    на ф-цию ReAlloc. которая используется Far'ом для аллокации "неограниченных"
    возвращаемых "неограниченных" строк (и освобождения памяти - см. ниже).
    В случае отсуствия в диалоге IsEdit полей, можно передавать NULL.

    При обработке Dialog/DialoEx осуществляется дополнительная проверка 
    параметра DataOut - если MaxLen!=0, то 
       IsBadWritePtr(DataOut,MaxLen*sizeof(wchar_t))
    если же MaxLen==0, то ReAlloc не может быть NULL.
        IsBadReadDataIn должен быть valid read ptr, а DataOut (если Ь

    Если параметр (одного из Item) невалиден, до возвращается -1 БЕЗ исполнения
    диалога.

    Если после "отработки" диалога, при возвращении строк ReAlloc вернёт NULL,
    то будет освобождена вся ранее захваченная им память (через ReAlloc(ptr, 0);)
    и так же возвращена -1.

    При нормальном же завершении Dialog/DialogEx плугин должен сам освободить
    память (все OutPtr) если, конечно, выделял её динамически :)

***

2. Выкинута ф-ция FSF.FreeDialogAnsStr - она теперь не нужна

3. Некоторое (попавшееся по пути :) убирание знаковых целых там где им
   сoвсем не место. По хорошему, надо бы тормознуть все правки и сначала
   навести порядок с этим...

4. Пара ошибок предыдущих патчей обнаруженная в посиках отавшейся ошибки 
   в использовании CutToSlash :)


t-rex 09.11.2007 21:34:19 +0200 - build 329

1. Исправил ещё одни недочёт в АПЙ для x64 версии. Надеюсь что это последний.

t-rex 09.11.2007 18:12:56 +0200 - build 328

1. В UnicodeString::GetBuffer nLength переименован в nSize.

от Alex Alabuzhev:

2. API 1.7:
   a) Control: всё, кроме:
      - в FCTL_GET[ANOTHER]PANELINFO не заполняются поля PanelItems и SelectedItems;
      - не реализован FCTL_SET[ANOTHER]SELECTION, т. к. зависит от предыдущего.
   b) MkLink
   c) GetNumberOfLinks
   d) правильно работает DM_KEY
   e) пропущен break после VCTL_GETINFO в ViewerControl

svs 09.11.2007 15:54:24 +0300 - build 327

1. Mantis#0000352: Undo, вызываемое CTRL+Z не работает если открыть существующий файл на редактирование 
   Проблема в том, что в 1.7x Editor::FreeAllocatedData вызывалась только из деструктора класса Editor.
   В 1.8x эта же функция так же вызывается из FileEditor::LoadFile, при этом массив UndoData удаляется.
   В общем, сделал очередную затычку - новый параметр у Editor::FreeAllocatedData - удалять или очищать
   массив UndoData.
   Для номальной работы (в т.ч. и для реализации Redo) необходимо отказаться от массива в пользу
   двусвязанного списка (или еще чего...)

t-rex 09.11.2007 13:18:53 +0200 - build 326

1. Различные фиксы и улучшения связанные с string.GetBuffer().

2. Немного правок на предмет табы-пробелы в коде.

svs 09.11.2007 11:57:41 +0300 - build 325

1. TVar вынесен в отдельный модуль tvar.?pp + компилятор из macro.cpp в syntax.cpp

2. KeyNameToKey теперь для макроязыка возвращает -1.

3. GetMacroParseError - теперь функция класса Macro.

4. После 2280 пункт 6 отвалился $MMode.
   Теперь $MMode будет компилится по правилам...
   т.е. если раньше было для "$MMode 1":
     0: MCODE_OP_MACROMODE
     1: '1'
   то теперь все встало на свои места:
     0: MCODE_OP_PUSHINT
     1: HIDWORD(1)
     2: LODWORD(1)
     3: MCODE_OP_MACROMODE

5. Mantis#0000351: ACTL_POSTKEYSEQUENCE: пауза при выполнении и лишняя перерисовка 


t-rex 07.11.2007 17:47:14 +0200 - build 324

1. Пару мелких BUGBUG и немного правок на предмет табы-пробелы в коде.

zg 05.11.2007 12:04:08 +0200 - build 323

1. Траблы с...
     > есть 2 макроса 
     > а) в области shell Ctrl-CapsLock=CtrlShiftTab flock(1,2) 
     > б) в области редактора Ctrl-CapsLock=CtrlShiftTab flock(1,2) 
     > 
     > 0. в shell открыли файл в редаторе, переключились снова в shell 
     > 1. нажали Ctrl-CapsLock, у нас таки есть макрос, макрос запускается 
     > 2. макрос отработал, в конце саданул в очередь Up-Down для VK_CAPITAL (тот самый flock(1,2)) 
     > 3. макрос закончился, но: 
     > 3.1 состояние Ctrl - в "нажато" 
     > 3.2 на подходе Up-Down для капслоск 
     > 4. ФАР видит в очереди CtrlCapsLock, проверяет, что мы в редакторе, а там такой же макрос тоже есть - начинает работать макрос 
     > 5. goto п.2 
     > 
     > Помогает только кнопка на морде системного блока 

   исправлено зависание. но так как во время физического нажатия *Lock программно изменить состояние этого самого *Lock нельзя, то макросы надо чуть доработать:
   CtrlCapsLock="CtrlShiftTab %a=flock(1,-1)&1; $while((flock(1,-1)&1)==%a) sleep(50) flock(1,2) $end"

yjh 05.11.2007 05:01:40 +0300 - build 322

1. Для возможности обхода недоделок в API добавлена FSF.FreeDialogAnsStr
   (освобождение памяти аллоцированной ядром для ответа в DI_EDIT).
   Пример использования можно посмотреть в MacroView


t-rex 04.11.2007 22:41:29 +0200 - build 321

1. Исправил пару мелких BUGBUG, в ком строке и запускаторе.

yjh 04.11.2007 22:21:28 +0300 - build 320

1. В FarKeyToName параметр Size и возвращаемое значение в символах, а не
   байтах.

yjh 04.11.2007 21:33:24 +0300 - build 319

1. Добавлена нормальная имплементация FarKeyToName. Изменения в API:
   typedef size_t  (WINAPI *FARSTDKEYTOKEYNAME)(int Key,wchar_t *KeyText,size_t Size);
   Возвращает общий размер (с финальным нулём) скопированный в KeyText.
   Если Size == 0, то возвращает необходимый размер

t-rex 01.11.2007 23:37:35 +0200 - build 318

от chupakabra:

1. При отрисовке рамки вывода информации о панели плагина (Ctrl+L) не используется BoxSymbols[].

t-rex 01.11.2007 22:42:35 +0200 - build 317

от Alex Alabuzhev:

1. API 1.7:
   - ViewerControl
   - еще несколько сообщений Dialog API
   - Text: рекурсия при Str = NULL

svs 01.11.2007 16:57:56 +0300 - build 316

1. Mantis#0000344: Ключи для отключения при запуске макросов / автостартующих макросов
   [+] Добавлены параметры командной строки:
       /m - при старте FAR не будет загружать макросы из реестра
       /ma - при старте ФАР не будет исполнять автостартующие макросы.

2. Падение, если в поисковике файлов в качестве маски указать "*.*, ,*.*"

3. В Хелпе FarEng.hlf.m4 есть русские буковки!
   В очередном патче кто-нить исправьте сей недостаток :-)


t-rex 30.10.2007 20:55:12 +0200 - build 315

от Alex Alabuzhev (с долей исправлений от меня :):
Вообще всё это надо очень хорошо потом протестировать.

1. API 1.7:
   - более-менее рабочий DialogEx.
   - AdvControl.
   - в FARKEYSEQUENCEFLAGS пропущен флаг KSFLAGS_REG_MULTI_SZ

svs 29.10.2007 09:52:31 +0300 - build 314

от _anton_ (?)

1. в plugin.hpp второй параметр у функции MakeDirectoryW char* вместо
   wchar_t*.

t-rex 28.10.2007 21:10:05 +0200

1. Мелкое исправление в EXCEPTION лицензии, неправельный набор слов
   приводил к тому что плагины должны были использовать один или все хидеры
   плагинов а не любой чтоб не попадать под лицензию фара.
   Но полюбому в самих хедерах и так написано что их можно юзать, в LICENSE это
   написано для суммирования.

t-rex 28.10.2007 20:04:06 +0200 - build 313

от Alexandr Zamaraev:

1. Улучшение GCC сборки.

t-rex 28.10.2007 17:59:38 +0200 - build 312

1. По наводке Yurij, в истории редактора\въювера теперь нет ограничения на размер строки,
   ну и за одно падать перестало :).

t-rex 28.10.2007 17:31:13 +0200 - build 311

от Alexandr Zamaraev (Tonal):

1. Сборка под GCC 4.2.1

t-rex 28.10.2007 16:37:51 +0200 - build 310

от Alex Alabuzhev:

1. API 1.7:
   a) Dialog (вроде всё), DialogEx (пока без обработчика) (wrap.cpp)
   b) Menu: пользовательская метка выбора (FarMenuItem.Checked>1) во враппере не перекодировалась
      в юникод (wrap.cpp), глубже тоже были грабли - приводилось к char (vmenu.cpp)

svs 28.10.2007 17:00:58 +0300 - build 

1. Добавлен файл SYSLOG-RU, описывающий элементы логирования в FAR`е

svs 28.10.2007 01:54:39 +0300 - build 309

1. Macro: Падение при записи последовательности с клавиатуры.

2. Вернем обратно KEY_MACRO_BASE в разряд "клавиш".
   Есть проблемы.


svs 28.10.2007 01:15:53 +0300 - build 308

from DrKnS (Alex Alabuzhev): 

1. при выводе плагинового диалога в заголовке консоли был мусор

2. при закрытии некоторых диалогов фар падал из-за неинициализированных переменных.

3. поправлена рамка внизу панели (flshow.cpp).

4. Editor: падала дебажная версия на выходе из редактора после сохранения

5. Editor: неправильно отрезался путь сохр. файла
   
6. Editor: если новый файл и вышли без сохр - UpdateFileList() не вызываем


t-rex 27.10.2007 22:08:48 +0200 - build 307

1. После 301 всплыл глюк с не вытеранием FEDITLINE_CLEARFLAG у Edit контролев.

t-rex 27.10.2007 20:05:33 +0200 - build 306

1. Оптимизация вывода строк редактора на экран, очень ощутимо на очень длинных строках.

2. Убрал SHITHAPPENS за ненадобностью.

t-rex 27.10.2007 17:05:41 +0200 - build 305

от chupakabra:

1. Вход в бесконечный цикл в FarMkTempEx().

2. DeleteFileWithFolder() удаляет только файл и оставляет каталог.

svs 27.10.2007 15:37:28 +0300 - build 304

1. Добавлен MCODE_OP_NOP

2. Уточнения кода по поводу падения во время удаления макроса
   и/или воспроизведенния...


t-rex 27.10.2007 14:18:57 +0200 - build 303

1. Исправил Debug и GCC сборку, и ещё пару варнингов.

svs 27.10.2007 13:15:23 +0300 - build 302

1. Уточнение в KeyMacro::MkTextSequence.

svs 26.10.2007 19:09:24 +0300 - build 301

Поехали....

1. MCODE_OP_EXPR и MCODE_OP_DOIT удалены как класс.

2. KEY_MACRO_BASE ... KEY_MACRO_ENDBASE ужО не "клавиши"!
   Остались только KEY_OP_*, кторые являются "клавишами"

3. В логирование добавлен _MOUSE_EVENT_RECORD_Dump()

4. Изменена SetFLockState
   GetKeyboardState отстой, работает только в дебажной версии (вот ить!)
   вместо нее юзаем нашу GetKeyState()

5. Хмм... а, ну да, оп-коды макросов теперь навинаются с 0
   (небольшое приближение к...)

6. В парсере макросов.
   между MCODE_OP_KEYS и MCODE_OP_ENDKEYS находятся настоящие клавиши!
   сейчас можем наблюдать фигню типа когда parseMacroString() каждую
   "настояшую клавишу" обрамляет этими кода (избыток!), но
   это промежуточный этап....
   В конце будет отдельный DLL, который ФАРу будет отдавать только байткод.

7. В PostNewMacro() добавлен новый параметр...
   предполагается (сейчас!), что плагины "пидалят" макросы с чистыми
   кодами клавиш!
   Но т.к. эта функция испльзуется не только для плагинов, то...
   ...нужно отличать "где мы".

9. Траблы с...
     есть 2 макроса 
     а) в области shell Ctrl-CapsLock=CtrlShiftTab flock(1,2) 
     б) в области редактора Ctrl-CapsLock=CtrlShiftTab flock(1,2) 

     0. в shell открыли файл в редаторе, переключились снова в shell 
     1. нажали Ctrl-CapsLock, у нас таки есть макрос, макрос запускается 
     2. макрос отработал, в конце саданул в очередь Up-Down для VK_CAPITAL (тот самый flock(1,2)) 
     3. макрос закончился, но: 
     3.1 состояние Ctrl - в "нажато" 
     3.2 на подходе Up-Down для капслоск 
     4. ФАР видит в очереди CtrlCapsLock, проверяет, что мы в редакторе, а там такой же макрос тоже есть - начинает работать макрос 
     5. goto п.2 

     Помогает только кнопка на морде системного блока 


t-rex 26.10.2007 14:34:01 +0200 build 300

1. Все готовы? Are you ready? :)
